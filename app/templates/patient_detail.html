{% extends "base.html" %}

{% block title %}{{ patient.full_name }} - PatientFlow{% endblock %}

{% block content %}
<div class="patient-detail">
    <div class="patient-header">
        <div class="patient-header-main">
            <div class="patient-avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div>
                <h1>{{ patient.full_name }}</h1>
                <p class="patient-meta">
                    <span class="meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        {{ patient.date_of_birth.strftime('%B %d, %Y') }}
                    </span>
                    <span class="meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        {{ patient.phone or 'No phone' }}
                    </span>
                </p>
            </div>
        </div>
        <span class="badge badge-{{ patient.intake.status }} badge-large">
            {% if patient.intake.status == 'complete' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            {% elif patient.intake.status == 'in_progress' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
            {% elif patient.intake.status == 'flagged' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
            </svg>
            {% else %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
            </svg>
            {% endif %}
            {{ patient.intake.status | replace('_', ' ') | title }}
        </span>
    </div>

    <div class="progress-section">
        <div class="progress-header">
            <span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                Intake Progress
            </span>
            <span class="progress-percentage">{{ patient.intake.completion_percentage }}%</span>
        </div>
        <div class="progress-bar large">
            <div class="progress-fill" style="width: {{ patient.intake.completion_percentage }}%"></div>
        </div>
    </div>

    {% if patient.intake.status == 'flagged' %}
    <div class="alert alert-warning">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <strong>Flagged:</strong> {{ patient.intake.flagged_reason }}
    </div>
    {% endif %}

    <div class="workflow-steps">
        <!-- Step 1: Personal Info -->
        <div class="step {% if patient.intake.personal_info_complete %}complete{% endif %}">
            <div class="step-header">
                <span class="step-icon">
                    {% if patient.intake.personal_info_complete %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    {% else %}1{% endif %}
                </span>
                <div class="step-header-content">
                    <span class="step-title">Personal Information</span>
                    <span class="step-subtitle">Demographics and contact details</span>
                </div>
            </div>
            <div class="step-content">
                {% if patient.intake.personal_info_complete %}
                <p class="step-status">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Completed
                </p>
                {% else %}
                <form method="POST" action="{{ url_for('main.update_patient_intake', patient_id=patient.id) }}">
                    <input type="hidden" name="step" value="personal_info_complete">
                    <input type="hidden" name="action" value="complete">
                    <button type="submit" class="btn btn-small btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Mark Complete
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Step 2: Insurance Verification -->
        <div class="step {% if patient.intake.insurance_verified %}complete{% endif %}">
            <div class="step-header">
                <span class="step-icon">
                    {% if patient.intake.insurance_verified %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    {% else %}2{% endif %}
                </span>
                <div class="step-header-content">
                    <span class="step-title">Insurance Verification</span>
                    <span class="step-subtitle">Provider and policy information</span>
                </div>
            </div>
            <div class="step-content">
                {% if patient.intake.insurance_verified %}
                <div class="step-data">
                    <p><strong>Provider:</strong> {{ patient.intake.insurance_provider or 'N/A' }}</p>
                    <p><strong>Policy #:</strong> {{ patient.intake.insurance_policy_number or 'N/A' }}</p>
                </div>
                {% else %}
                <form method="POST" action="{{ url_for('main.update_patient_intake', patient_id=patient.id) }}" class="step-form">
                    <input type="hidden" name="step" value="insurance_verified">
                    <div class="form-group">
                        <label>Insurance Provider</label>
                        <input type="text" name="insurance_provider" placeholder="e.g., Blue Cross">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Policy Number</label>
                            <input type="text" name="insurance_policy_number">
                        </div>
                        <div class="form-group">
                            <label>Group Number</label>
                            <input type="text" name="insurance_group_number">
                        </div>
                    </div>
                    <div class="step-actions">
                        <button type="submit" name="action" value="complete" class="btn btn-small btn-primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Verify & Complete
                        </button>
                        <button type="submit" name="action" value="flag" class="btn btn-small btn-warning">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                            </svg>
                            Flag Issue
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Step 3: Medical History -->
        <div class="step {% if patient.intake.medical_history_complete %}complete{% endif %}">
            <div class="step-header">
                <span class="step-icon">
                    {% if patient.intake.medical_history_complete %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    {% else %}3{% endif %}
                </span>
                <div class="step-header-content">
                    <span class="step-title">Medical History</span>
                    <span class="step-subtitle">Allergies, medications, and conditions</span>
                </div>
            </div>
            <div class="step-content">
                {% if patient.intake.medical_history_complete %}
                <div class="step-data">
                    <p><strong>Allergies:</strong> {{ patient.intake.allergies or 'None reported' }}</p>
                    <p><strong>Medications:</strong> {{ patient.intake.current_medications or 'None reported' }}</p>
                    <p><strong>Conditions:</strong> {{ patient.intake.medical_conditions or 'None reported' }}</p>
                </div>
                {% else %}
                <form method="POST" action="{{ url_for('main.update_patient_intake', patient_id=patient.id) }}" class="step-form">
                    <input type="hidden" name="step" value="medical_history_complete">
                    <div class="form-group">
                        <label>Known Allergies</label>
                        <textarea name="allergies" rows="2" placeholder="List any allergies..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Current Medications</label>
                        <textarea name="current_medications" rows="2" placeholder="List current medications..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Medical Conditions</label>
                        <textarea name="medical_conditions" rows="2" placeholder="List any medical conditions..."></textarea>
                    </div>
                    <button type="submit" name="action" value="complete" class="btn btn-small btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Save & Complete
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Step 4: Consent Forms -->
        <div class="step {% if patient.intake.consent_forms_signed %}complete{% endif %}">
            <div class="step-header">
                <span class="step-icon">
                    {% if patient.intake.consent_forms_signed %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    {% else %}4{% endif %}
                </span>
                <div class="step-header-content">
                    <span class="step-title">Consent Forms</span>
                    <span class="step-subtitle">Required document signatures</span>
                </div>
            </div>
            <div class="step-content">
                {% if patient.intake.consent_forms_signed %}
                <p class="step-status">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/><polyline points="9 15 12 18 20 10"/>
                    </svg>
                    All forms signed
                </p>
                {% else %}
                <form method="POST" action="{{ url_for('main.update_patient_intake', patient_id=patient.id) }}">
                    <input type="hidden" name="step" value="consent_forms_signed">
                    <input type="hidden" name="action" value="complete">
                    <p class="step-instructions">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        Confirm patient has signed all required consent forms.
                    </p>
                    <button type="submit" class="btn btn-small btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Confirm Signed
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Step 5: ID Verification -->
        <div class="step {% if patient.intake.id_verified %}complete{% endif %}">
            <div class="step-header">
                <span class="step-icon">
                    {% if patient.intake.id_verified %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    {% else %}5{% endif %}
                </span>
                <div class="step-header-content">
                    <span class="step-title">ID Verification</span>
                    <span class="step-subtitle">Government-issued identification</span>
                </div>
            </div>
            <div class="step-content">
                {% if patient.intake.id_verified %}
                <p class="step-status">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="16" rx="2"/>
                        <circle cx="9" cy="10" r="2"/><path d="M15 8h2"/><path d="M15 12h2"/>
                        <path d="M7 16h10"/>
                    </svg>
                    Identity verified
                </p>
                {% else %}
                <form method="POST" action="{{ url_for('main.update_patient_intake', patient_id=patient.id) }}">
                    <input type="hidden" name="step" value="id_verified">
                    <input type="hidden" name="action" value="complete">
                    <p class="step-instructions">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        Verify patient identity with government-issued ID.
                    </p>
                    <button type="submit" class="btn btn-small btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Confirm Verified
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    {% if patient.intake.status == 'complete' %}
    <div class="completion-banner">
        <div class="completion-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <h2>Intake Complete</h2>
        <p>All steps have been completed. Patient is ready for their appointment.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
